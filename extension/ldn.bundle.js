!function(e){var t={};function n(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(r,s,function(t){return e[t]}.bind(null,s));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=5)}([function(e,t){e.exports.ViewState=Object.freeze({IN_LOBBY:1,OUT_LOBBY:0,CONNECT_LOBBY:2}),e.exports.ControllerState=Object.freeze({INACTIVE:-1,PENDING:0,PAUSE:1,PLAY:2}),e.exports.SyncState=Object.freeze({INACTIVE:-1,PENDING:0,SYNCED:1}),e.exports.Protocol=Object.freeze({SUCCESS:1,FAIL:0,Messages:{START_LOBBY:"start_lobby",START_LOBBY_ACK:"start_lobby_ack",DISCONNECT_LOBBY:"disconnect_lobby",DISCONNECT_LOBBY_ACK:"disconnect_lobby_ack",CONNECT_LOBBY:"connect_lobby",CONNECT_LOBBY_ACK:"connect_lobby_ack",SYNC_INIT:"sync_init",SYNC_INIT_ACK:"sync_init_ack",SYNC_TIME:"sync_time",SYNC_TIME_ACK:"sync_time_ack",SYNC_END:"sync_end",SYNC_END_ACK:"sync_end_ack",UPDATE_URL:"update_url",UPDATE_URL_ACK:"update_url_ack",UPDATE_CONTROL:"update_control",UPDATE_CONTROL_ACK:"update_control_ack",UPDATE_TIME:"update_time",UPDATE_TIME_ACK:"update_time_ack",UPDATE_SEEK:"update_seek",UPDATE_SEEK_ACK:"update_seek_ack",UPDATE_STATE:"update_state",UPDATE_STATE_ACK:"update_state_ack",UPDATE_CONTROL_SCRIPT:"update_control_script",UPDATE_CONTROL_SCRIPT_ACK:"update_control_script_ack",POPUP_LOADED:"popup_loaded",POPUP_LOADED_ACK:"popup_loaded_ack"}}),e.exports.WS_URL=Object.freeze("ws://10.0.0.47:3000/")},function(e,t){function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}e.exports=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;n(this,e),this.elapsed=t,this.duration=r}var t,s,o;return t=e,o=[{key:"fromJson",value:function(t){try{var n=JSON.parse(t);return new e(n.elapsed,n.duration)}catch(e){return console.log("<Error> Tried to instantiate progress state with corrupt data!"),null}}}],(s=null)&&r(t.prototype,s),o&&r(t,o),e}()},function(e,t,n){function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var o=n(1),a=n(0);e.exports=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new o,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,c=arguments.length>4&&void 0!==arguments[4]&&arguments[4],l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:a.ControllerState.INACTIVE,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:a.SyncState.INACTIVE;r(this,e),this.lobbyId=s,this.id=i,this.controllerState=l,this.urlParams=t,this.progressState=n,this.controller=c,this.syncState=u}var t,n,i;return t=e,i=[{key:"fromJson",value:function(t){try{var n=JSON.parse(t);return new e(n.urlParams,o.fromJson(JSON.stringify(n.progressState)),n.lobbyId,n.id,n.controller,n.controllerState,n.syncState)}catch(e){throw new Error(e)}}}],(n=null)&&s(t.prototype,n),i&&s(t,i),e}()},,,function(e,t,n){"use strict";n.r(t);var r=n(0),s=n.n(r);function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var a=function(){function e(){var t=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.loaded=!1,this.tabId=-1,this._queryNetflixTab(),chrome.tabs.onCreated.addListener((function(e){t.onCreate(e)})),chrome.tabs.onUpdated.addListener((function(e,n,r){t.onUpdate(e,n,r)})),chrome.tabs.onRemoved.addListener((function(e,n){t.onRemove(e,n)})),chrome.webNavigation.onCompleted.addListener((function(n){e.isNetflix(n)&&n.url.includes("watch/")&&(t.loaded=!1,t._startControllerScript())})),console.log("<TabListener> Tab listener started!")}var t,n,r;return t=e,r=[{key:"isNetflix",value:function(e){return!!e&&e.url.includes("https://www.netflix.com/")}},{key:"getUrlParams",value:function(e){return e?e.url.split("netflix.com/")[1].split("?")[0]:""}}],(n=[{key:"_queryNetflixTab",value:function(){var e=this;chrome.tabs.query({title:"Netflix"},(function(t){if(0!==t.length)return e._update(t[0]),t[0];e.tabId=-1}))}},{key:"_startControllerScript",value:function(){var e=this;d.getInstance().user.controllerState=s.a.ControllerState.PENDING,this.loaded?chrome.tabs.sendMessage(this.tabId,{type:s.a.Protocol.Messages.UPDATE_CONTROL_SCRIPT,code:!0}):chrome.tabs.executeScript(this.tabId,{file:"loader.js",runAt:"document_start"},(function(t){e.loaded=!0,console.log("<TabListener> Attempted to run loader script!")}))}},{key:"_disableControllerScript",value:function(){chrome.tabs.sendMessage(this.tabId,{type:s.a.Protocol.Messages.UPDATE_CONTROL_SCRIPT,code:!1})}},{key:"_uncacheTab",value:function(){console.log("<TabListener> Removing tab id: "+this.tabId),this.loaded=!1,this.tabId=-1}},{key:"_cacheTab",value:function(e){console.log("<TabListener> Setting tab id: "+e),this.tabId=e}},{key:"_update",value:function(t){if(e.isNetflix(t)){chrome.pageAction.show(t.id,void 0),console.log("<TabListener> Updated: ",t.url),this.isTabCached()||this._cacheTab(t.id),t.url.includes("watch")?(d.getInstance().user.urlParams.includes("watch")&&this._disableControllerScript(),this._startControllerScript()):t.url.includes("browse")&&(d.getInstance().user.controllerState=s.a.ControllerState.INACTIVE,this._disableControllerScript());var n=e.getUrlParams(t);d.getInstance().user.urlParams!==n&&(console.log("<TabListener> Updated user url parameters: "+n),d.getInstance().setUrlParams(n))}else this._uncacheTab()}},{key:"isTabCached",value:function(){return-1!==this.tabId}},{key:"onCreate",value:function(e){console.log("<TabListener> Created: ",e.url),this._update(e)}},{key:"onUpdate",value:function(e,t,n){n.url!==d.getInstance().user.urlParams&&t.status&&"complete"===t.status&&this._update(n)}},{key:"onRemove",value:function(e,t){e===this.tabId&&this._uncacheTab()}}])&&o(t.prototype,n),r&&o(t,r),e}(),i=n(2),c=n.n(i);function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function u(e,t,n){return t&&l(e.prototype,t),n&&l(e,n),e}n.d(t,"default",(function(){return d}));var d=function(){function e(){var t=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.user=new c.a,this.ws=null,this.tabListener=new a,chrome.runtime.onMessage.addListener((function(e,n,r){return t._onRuntimeMessage(e,n,r)})),console.log("<LDN> LDN has been started!")}return u(e,null,[{key:"getInstance",value:function(){return this._instance||(this._instance=new e),this._instance}}]),u(e,[{key:"_connect",value:function(){var e=this;return new Promise((function(t,n){if(e.isSocketConnected())t(null);else try{e.ws=new WebSocket(s.a.WS_URL),e.ws.onopen=function(){console.log("<LDN> Connected to WebSocket server"),e.ws.onclose=e._onClose,e.ws.onerror=e._onError,t(null)}}catch(e){n(e)}}))}},{key:"_onClose",value:function(e){console.log("<LDN> Server close"),console.log(e)}},{key:"_onError",value:function(e){console.log("<LDN> Server error"),console.log(e)}},{key:"startLobby",value:function(e){var t=this;return new Promise((function(n,r){t._connect().then((function(){e.user=JSON.stringify(t.user),t.ws.send(JSON.stringify(e)),t.ws.onmessage=function(e){try{var o=JSON.parse(e.data);o.type===s.a.Protocol.Messages.START_LOBBY_ACK&&o.code===s.a.Protocol.SUCCESS?(t.user.lobbyId=o.lobbyId,t.user.controller=!0,null===t.user.id&&(t.user.id=o.userId),n(!0)):r(!1)}catch(e){r(!1)}finally{t.ws.onmessage=function(e){return t._onMessage(e)}}}})).catch((function(e){r(e)}))}))}},{key:"connectLobby",value:function(e){var t=this;return new Promise((function(n,r){t._connect().then((function(){e.user=JSON.stringify(t.user),t.ws.send(JSON.stringify(e)),t.ws.onmessage=function(o){try{var a=JSON.parse(o.data);if(a.type===s.a.Protocol.Messages.CONNECT_LOBBY_ACK&&a.code){if(t.user.lobbyId=e.lobbyId,t.user.controller=!1,null===t.user.id&&(t.user.id=a.userId),a.controller){var i=JSON.parse(a.controller);t._onMessage({data:JSON.stringify({type:s.a.Protocol.Messages.UPDATE_URL,urlParams:i.urlParams})})}n(!0)}else r(!1)}catch(e){console.log(e),r(!1)}finally{t.ws.onmessage=function(e){return t._onMessage(e)}}}})).catch((function(e){r(e)}))}))}},{key:"disconnectLobby",value:function(e){var t=this;this._connect().then((function(){e.user=JSON.stringify(t.user),t.ws.send(JSON.stringify(e))})).catch((function(e){console.log(e)}))}},{key:"setUrlParams",value:function(e){var t=this;this.user.urlParams=e,this.user.controller&&e.includes("watch/")&&this._connect().then((function(){var e={type:s.a.Protocol.Messages.UPDATE_URL,urlParams:t.user.urlParams,user:JSON.stringify(t.user)};t.ws.send(JSON.stringify(e))}))}},{key:"isConnected",value:function(){return this.user.currentLobby&&this.user.id}},{key:"isSocketConnected",value:function(){return this.ws&&this.ws.readyState===this.ws.OPEN}},{key:"_onMessage",value:function(e){try{var t=JSON.parse(e.data);switch(console.log("<LDN> Received message with type: ",t.type),t.type){case s.a.Protocol.Messages.DISCONNECT_LOBBY_ACK:t.code===s.a.Protocol.SUCCESS&&(this.user.lobbyId=null,this.user.controller=!1);break;case s.a.Protocol.Messages.UPDATE_URL:this.user.urlParams!==t.urlParams&&chrome.tabs.update(this.tabListener.tabId,{url:"https://netflix.com/"+t.urlParams});break;case s.a.Protocol.Messages.UPDATE_CONTROL:this.user.controller=t.code;break;case s.a.Protocol.Messages.SYNC_TIME:chrome.tabs.sendMessage(this.tabListener.tabId,t);break;case s.a.Protocol.Messages.SYNC_INIT_ACK:this.user.syncState=t.syncState;break;case s.a.Protocol.Messages.SYNC_END:this.user.syncState=t.syncState,chrome.tabs.sendMessage(this.tabListener.tabId,t);break;case s.a.Protocol.Messages.UPDATE_SEEK:case s.a.Protocol.Messages.UPDATE_STATE:delete t.user,chrome.tabs.sendMessage(this.tabListener.tabId,t);break;default:console.log("<LDN> Unhandled msg: ",t.type)}}catch(e){console.log(e)}}},{key:"_onRuntimeMessage",value:function(e,t,n){try{switch(e.type){case s.a.Protocol.Messages.UPDATE_TIME:this.user.progressState=e.progressState;break;case s.a.Protocol.Messages.UPDATE_STATE:this.user.controllerState=e.controllerState,this.user.controller&&(e.user=JSON.stringify(this.user),this.ws.send(JSON.stringify(e)));break;case s.a.Protocol.Messages.UPDATE_SEEK:this.user.progressState=e.progressState,this.user.controller&&(e.user=JSON.stringify(this.user),this.ws.send(JSON.stringify(e)));break;case s.a.Protocol.Messages.SYNC_INIT:case s.a.Protocol.Messages.SYNC_TIME_ACK:e.user=JSON.stringify(this.user),this.ws.send(JSON.stringify(e))}}catch(e){console.log(e)}}}]),e}();window.ldn=d.getInstance()}]);